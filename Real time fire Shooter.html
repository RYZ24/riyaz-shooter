<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Multiplayer Educational Game</title>
  <style>
    :root{
      --sky:#bfe7ff; --river:#57b1ff; --river-deep:#2b80d0; --grass:#84cc16; --path:#c2a37a;
      --board:#ffeded; --board-text:#b91c1c; --ui:#0f172a; --good:#16a34a; --bad:#ef4444;
      --card:#ffffffcc; --shadow:0 8px 28px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; color:#0b1220; background:#f6fbff}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:50}
    header h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
    header .pill{font:12px/1.2 ui-monospace, Menlo, monospace;background:#eef6ff;color:#0a3a7a;padding:4px 8px;border-radius:999px;border:1px solid #d7e8ff}
    main{display:grid;grid-template-columns:360px 1fr;gap:12px; padding:12px; height:calc(100% - 64px)}
    .panel{background:var(--card);backdrop-filter:blur(8px); border:1px solid #e9eef6; border-radius:16px; padding:14px; box-shadow:var(--shadow); overflow:auto}
    .panel h2{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .input, textarea{width:100%;padding:10px;border:1px solid #d8e3f2;border-radius:10px;background:#fff}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:var(--shadow);}
    button.primary{background:#2563eb;color:#fff}
    button.ghost{background:#f2f7ff}
    button.danger{background:#fee2e2;color:#991b1b}
    button.good{background:var(--good);color:#fff}
    button.bad{background:var(--bad);color:#fff}
    .grid{display:grid; gap:8px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}
    .muted{opacity:.8; font-size:12px}
    .list{display:flex;flex-direction:column;gap:6px}
    .player{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px dashed #d8e3f2;border-radius:10px;background:#fff}
    .score{font:12px ui-monospace, monospace;background:#eef6ff;padding:2px 8px;border-radius:999px;border:1px solid #d7e8ff}
    canvas{width:100%;height:100%;display:block;border-radius:16px;border:1px solid #e9eef6; background:#000}
    .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:12px}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:var(--shadow);z-index:999}
    .hidden{display:none !important}
    .char{display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;border:2px solid transparent;border-radius:12px;background:#fff;cursor:pointer}
    .char[aria-disabled="true"]{opacity:.4;pointer-events:none}
    .char.selected{border-color:#2563eb}
    .tiny{font-size:11px;color:#334155}
    details{background:#fff;border:1px solid #e9eef6;border-radius:12px;padding:8px}
    summary{cursor:pointer;font-weight:600}
  </style>
</head>
<body>
  <header>
    <h1>üõ∂ Live Multiplayer Educational Game <span class="pill" id="roomPill">No room</span></h1>
    <div class="legend">
      <span><span class="dot" style="background:#2563eb"></span>‡§Ü‡§™</span>
      <span><span class="dot" style="background:#6b7280"></span>‡§Ö‡§®‡•ç‡§Ø ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä</span>
      <span><span class="dot" style="background:#16a34a"></span>‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§¨‡•ã‡§∞‡•ç‡§°</span>
      <span><span class="dot" style="background:#ef4444"></span>‡§ó‡§≤‡§§ ‡§¨‡•ã‡§∞‡•ç‡§°</span>
    </div>
  </header>
  <main>
    <section class="panel" id="leftPanel">
      <h2>‡§∏‡•á‡§ü‡§Ö‡§™ / ‡§ú‡•â‡§á‡§®</h2>
      <div class="grid two">
        <button class="primary" id="btnHost">Admin (‡§ï‡§Æ‡§∞‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç)</button>
        <button class="ghost" id="btnJoin">Student (‡§ú‡•â‡§á‡§®)</button>
      </div>
      <div id="hostBox" class="hidden">
        <div class="grid two" style="margin-top:10px">
          <label class="grid">
            <span class="tiny">Game Duration (‡§Æ‡§ø‡§®‡§ü)</span>
            <input id="duration" class="input" type="number" min="1" max="120" value="5"/>
          </label>
          <label class="grid">
            <span class="tiny">Min Students (‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ)</span>
            <input id="minPlayers" class="input" type="number" min="1" max="200" value="2"/>
          </label>
        </div>
        <label class="grid" style="margin-top:10px">
          <span class="tiny">‡§™‡•ç‡§∞‡§∂‡•ç‡§® ("‡§™‡•ç‡§∞‡§∂‡•ç‡§® | ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™A | ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™B | ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™C | ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™D | ‡§∏‡§π‡•Ä ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§Ö‡§ï‡•ç‡§∑‡§∞") - ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§®</span>
          <textarea id="questionBank" rows="7" class="input">2 + 2 ‡§ï‡§ø‡§§‡§®‡§æ? | 4 | 5 | 6 | 3 | A
‡§≠‡§æ‡§∞‡§§ ‡§ï‡•Ä ‡§∞‡§æ‡§ú‡§ß‡§æ‡§®‡•Ä? | ‡§Æ‡•Å‡§Ç‡§¨‡§à | ‡§¶‡§ø‡§≤‡•ç‡§≤‡•Ä | ‡§ö‡•á‡§®‡•ç‡§®‡§à | ‡§ï‡•ã‡§≤‡§ï‡§æ‡§§‡§æ | B
Water ‡§ï‡§æ ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§∏‡•Ç‡§§‡•ç‡§∞? | HO | H2O | O2 | CO2 | B
5 √ó 6 = ? | 28 | 35 | 30 | 56 | C
Sun rises in the? | West | East | North | South | B</textarea>
        </label>
        <details style="margin-top:10px">
          <summary>üîê Firebase ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞)</summary>
          <div class="muted" style="margin-top:6px">
            ‡§á‡§∏ ‡§´‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§Ø‡•á Firebase Realtime Database ‡§ö‡§æ‡§π‡§ø‡§è. ‡§®‡•Ä‡§ö‡•á ‡§Ö‡§™‡§®‡§æ <b>firebaseConfig</b> ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§<br>
            <ol>
              <li>Firebase Console ‚Üí Project Settings ‚Üí General ‚Üí Your apps (Web) ‚Üí SDK setup and configuration</li>
              <li>‡§ï‡•â‡§®‡•ç‡§´‡§ø‡§ó ‡§ï‡§æ JS ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§®‡•Ä‡§ö‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</li>
              <li>Realtime Database ‡§¨‡§®‡§æ‡§Ø‡•á‡§Ç ‡§î‡§∞ Rules ‡§ï‡•ã ‡§®‡•Ä‡§ö‡•á ‡§µ‡§æ‡§≤‡•á ‡§¨‡•ç‡§≤‡•â‡§ï ‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</li>
            </ol>
          </div>
          <textarea id="firebaseConfigInput" rows="6" class="input" placeholder='{
  apiKey: "...",
  authDomain: "...",
  databaseURL: "https://<YOUR-PROJECT-ID>-default-rtdb.firebaseio.com",
  projectId: "...",
  appId: "..."
}'></textarea>
          <div class="muted" style="margin-top:6px">
            <b>Rules (‡§ï‡•â‡§™‡•Ä-‡§™‡•á‡§∏‡•ç‡§ü):</b>
            <pre style="white-space:pre-wrap;border:1px solid #e9eef6;border-radius:8px;padding:6px;background:#fff">{
  "rules": {
    ".read": false,
    ".write": false,
    "rooms": {
      "$pin": {
        ".read": "auth != null && query.orderByChild == 'public' ? true : auth != null",
        ".write": "auth != null",
        "players": {
          "$uid": {
            ".read": "auth.uid == $uid || root.child('rooms/'+$pin+'/adminId').val() == auth.uid",
            ".write": "auth.uid == $uid || root.child('rooms/'+$pin+'/adminId').val() == auth.uid"
          }
        },
        "state": { ".read": true, ".write": "root.child('rooms/'+$pin+'/adminId').val() == auth.uid" },
        "settings": { ".read": true, ".write": "root.child('rooms/'+$pin+'/adminId').val() == auth.uid" },
        "questions": { ".read": true, ".write": "root.child('rooms/'+$pin+'/adminId').val() == auth.uid" }
      }
    }
  }
}</pre>
          </div>
          <button class="primary" id="btnInitFirebase">üîå Firebase Connect</button>
        </details>
        <div style="margin-top:10px" class="grid two">
          <button class="bad" id="btnMakeRoom">Room ‡§¨‡§®‡§æ‡§è‡§Ç (PIN)</button>
          <button class="good" id="btnStart" disabled>Start</button>
        </div>
        <div class="muted" style="margin-top:6px">Start ‡§¨‡§ü‡§® ‡§â‡§§‡§®‡•á ‡§∏‡•ç‡§ü‡•Ç‡§°‡•á‡§Ç‡§ü ‡§ú‡•â‡§á‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§π‡§∞‡§æ ‡§π‡•ã‡§ó‡§æ ‡§ú‡§ø‡§§‡§®‡•á ‡§ä‡§™‡§∞ ‡§∏‡•á‡§ü ‡§π‡•à‡§Ç‡•§</div>
      </div>

      <div id="joinBox" class="hidden">
        <div class="grid two" style="margin-top:10px">
          <label class="grid">
            <span class="tiny">‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ</span>
            <input id="yourName" class="input" placeholder="Your name"/>
          </label>
          <label class="grid">
            <span class="tiny">Room PIN</span>
            <input id="roomPin" class="input" placeholder="6-digit PIN"/>
          </label>
        </div>
        <div class="grid three" id="charGrid" style="margin-top:10px"></div>
        <button class="primary" id="btnJoinRoom" style="margin-top:8px">Join</button>
      </div>

      <h2 style="margin-top:16px">Live Players</h2>
      <div class="list" id="playerList"></div>

      <h2 style="margin-top:16px">Leaderboard</h2>
      <div class="list" id="leaderboard"></div>

      <div class="row" style="margin-top:16px">
        <button id="btnLeave" class="danger hidden">Leave</button>
        <button id="btnRestart" class="ghost hidden">Restart</button>
        <button id="btnCloseRoom" class="danger hidden">Close Room</button>
      </div>
      <p class="muted" style="margin-top:10px">Tip: ‡§Ø‡§π ‡§è‡§ï <b>single-file</b> HTML ‡§π‡•à ‚Äî Chrome ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç‡•§ Multi-device sync ‡§ï‡•á ‡§≤‡§ø‡§è Firebase ‡§ö‡§æ‡§π‡§ø‡§è‡•§</p>
    </section>
    <section class="panel" style="position:relative">
      <canvas id="game"></canvas>
      <div id="overlay" class="hidden" style="position:absolute;inset:8px;padding:12px;background:#0008;color:#fff;border-radius:12px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;text-align:center">
        <div id="overlayText" style="font-size:18px"></div>
        <div id="rankList"></div>
      </div>
      <div id="toast" class="toast hidden"></div>
    </section>
  </main>

  <!-- Audio (tiny base64) -->
  <audio id="sndShoot" preload="auto" src="data:audio/wav;base64,UklGRhAYAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAZGF0YYAYAACAgICAgICAgP///wAAAP///wAAAP8AAP8AAP8A/wD/AAAA/wAAAP8AAP//AAAA" ></audio>
  <audio id="sndClap" preload="auto" src="data:audio/wav;base64,UklGRlQyAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAZGF0YfwyAACAgICAgICAf39/f39/f4CAgICAgICAgH9/f39/f39/gICAoKCgoKCggICAgICAgICAf39/f39/f4CAgICAgICA" ></audio>

  <script type="module">
    // ====== Utility ======
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const toast=(t)=>{const el=$('#toast'); el.textContent=t; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),1500)}
    const randomPin=()=>Math.floor(100000+Math.random()*900000)+''
    const now=()=>Date.now()

    // ====== Characters (simple, non-bold) ======
    const CHARACTERS=[
      {id:'c1', name:'Sparrow', emoji:'üê¶'},
      {id:'c2', name:'Deer', emoji:'ü¶å'},
      {id:'c3', name:'Fox', emoji:'ü¶ä'},
      {id:'c4', name:'Panda', emoji:'üêº'},
      {id:'c5', name:'Koala', emoji:'üê®'},
      {id:'c6', name:'Rabbit', emoji:'üê∞'},
      {id:'c7', name:'Penguin', emoji:'üêß'},
      {id:'c8', name:'Cat', emoji:'üê±'},
      {id:'c9', name:'Dog', emoji:'üê∂'},
      {id:'c10', name:'Chick', emoji:'üê•'},
      {id:'c11', name:'Mouse', emoji:'üê≠'},
      {id:'c12', name:'Turtle', emoji:'üê¢'}
    ]

    // Build character grid
    const charGrid=$('#charGrid');
    CHARACTERS.forEach(c=>{
      const div=document.createElement('button');
      div.className='char';
      div.innerHTML=`<div style="font-size:32px">${c.emoji}</div><div class="tiny">${c.name}</div>`
      div.dataset.id=c.id; div.dataset.name=c.name;
      div.addEventListener('click',()=>{
        $$('.char').forEach(x=>x.classList.remove('selected'));
        div.classList.add('selected');
      })
      charGrid.appendChild(div)
    })

    // ====== Firebase (loaded lazily after user clicks connect) ======
    let fbReady=false, app, db, auth, myUser=null;
    async function ensureFirebase(){
      if(fbReady) return true;
      // Load SDKs
      await Promise.all([
        import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js'),
        import('https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js')
      ]);
      const cfgText=$('#firebaseConfigInput').value.trim();
      if(!cfgText){ toast('Firebase config ‡§ö‡§æ‡§π‡§ø‡§è'); return false }
      let cfg; try{ cfg = Function('return ('+cfgText+')')() }catch(e){ toast('Config JSON ‡§ó‡§≤‡§§ ‡§π‡•à'); return false }
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
      const { getDatabase, ref, set, get, update, onValue, onDisconnect, serverTimestamp, remove, query, orderByChild, equalTo } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js');
      const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
      window._fb = {ref,set,get,update,onValue,onDisconnect,serverTimestamp,remove,query,orderByChild,equalTo}
      app = initializeApp(cfg);
      db = getDatabase(app);
      auth=getAuth(app);
      await signInAnonymously(auth);
      await new Promise(res=> onAuthStateChanged(auth,u=>{ if(u){ myUser=u; res() }}));
      fbReady=true; toast('Firebase connected');
      return true;
    }

    // ====== Room / Refs ======
    let isAdmin=false, pin=null, me=null, startedAt=null, durationMs=0, minPlayers=1, myLane=0;
    let roomRefs={}
    function setRoomPill(text){ $('#roomPill').textContent=text }

    function bindRoomRefs(){
      if(!pin) return;
      const r = (p)=>_fb.ref(db, `rooms/${pin}/`+p)
      roomRefs={
        root: _fb.ref(db, `rooms/${pin}`),
        players: _fb.ref(db, `rooms/${pin}/players`),
        settings: _fb.ref(db, `rooms/${pin}/settings`),
        state: _fb.ref(db, `rooms/${pin}/state`),
        questions: _fb.ref(db, `rooms/${pin}/questions`)
      }
    }

    // ====== UI Handlers ======
    $('#btnHost').onclick=()=>{ $('#hostBox').classList.remove('hidden'); $('#joinBox').classList.add('hidden') }
    $('#btnJoin').onclick=()=>{ $('#joinBox').classList.remove('hidden'); $('#hostBox').classList.add('hidden') }
    $('#btnInitFirebase').onclick=ensureFirebase

    $('#btnMakeRoom').onclick=async()=>{
      if(!(await ensureFirebase())) return;
      isAdmin=true; pin=randomPin(); setRoomPill('PIN '+pin)
      bindRoomRefs();
      const questions=parseQuestionBank($('#questionBank').value.trim());
      durationMs=+$('#duration').value*60*1000; minPlayers=+$('#minPlayers').value;
      const settings={ durationMs, minPlayers, createdAt: now() }
      const state={ status:'lobby', adminId: myUser.uid }
      await _fb.set(roomRefs.root, { pin, adminId: myUser.uid, settings, state, questions })
      listenRoom(); toggleAdminControls(true);
      $('#btnLeave').classList.remove('hidden');
      toast('Room ready. PIN ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç.')
    }

    $('#btnStart').onclick=async()=>{
      if(!isAdmin) return; // enable only when conditions met
      startedAt=now(); await _fb.update(roomRefs.state,{ status:'running', startedAt, endsAt: startedAt+durationMs })
      $('#btnStart').disabled=true; $('#btnStart').classList.remove('good');
    }

    $('#btnJoinRoom').onclick=async()=>{
      if(!(await ensureFirebase())) return;
      const name=$('#yourName').value.trim(); const pinInput=$('#roomPin').value.trim();
      if(!name||!pinInput){ toast('‡§®‡§æ‡§Æ ‡§î‡§∞ PIN ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ö‡§æ‡§π‡§ø‡§è'); return }
      const selected=$('.char.selected'); if(!selected){ toast('‡§è‡§ï character ‡§ö‡•Å‡§®‡•á‡§Ç'); return }
      pin=pinInput; setRoomPill('PIN '+pin); bindRoomRefs();
      // prevent duplicate characters
      const takenSnap = await _fb.get(roomRefs.players);
      if(takenSnap.exists()){
        const taken = Object.values(takenSnap.val()).map(p=>p.characterId)
        if(taken.includes(selected.dataset.id)) { toast('‡§Ø‡§π character ‡§ï‡§ø‡§∏‡•Ä ‡§î‡§∞ ‡§®‡•á ‡§≤‡•á ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à'); return }
      }
      me={ uid: myUser.uid, name, characterId:selected.dataset.id, characterName:selected.dataset.name, score:0, laneIdx: -1, joinedAt: now() }
      await _fb.update(roomRefs.players,{ [myUser.uid]: me })
      _fb.onDisconnect(_fb.ref(db,`rooms/${pin}/players/${myUser.uid}`)).remove()
      listenRoom(); $('#btnLeave').classList.remove('hidden');
    }

    $('#btnLeave').onclick=async()=>{ if(pin){ try{ await _fb.remove(_fb.ref(db,`rooms/${pin}/players/${myUser.uid}`)) }catch{} } resetLocal() }
    $('#btnCloseRoom').onclick=async()=>{ if(isAdmin&&pin){ await _fb.remove(roomRefs.root); resetLocal(); toast('Room closed') } }
    $('#btnRestart').onclick=async()=>{
      if(!isAdmin||!pin) return;
      const questions=parseQuestionBank($('#questionBank').value.trim());
      durationMs=+$('#duration').value*60*1000; minPlayers=+$('#minPlayers').value;
      await _fb.update(roomRefs.settings,{ durationMs, minPlayers });
      await _fb.set(roomRefs.questions, questions);
      await _fb.update(roomRefs.state,{ status:'lobby', startedAt:null, endsAt:null })
      toast('Lobby reset');
    }

    function toggleAdminControls(on){
      $('#btnCloseRoom').classList.toggle('hidden',!on);
      $('#btnRestart').classList.toggle('hidden',!on);
    }

    function resetLocal(){
      isAdmin=false; pin=null; me=null; startedAt=null; durationMs=0; minPlayers=1; myLane=0;
      setRoomPill('No room'); $('#btnLeave').classList.add('hidden'); toggleAdminControls(false);
      $('#overlay').classList.add('hidden'); $('#rankList').innerHTML='';
      $('#playerList').innerHTML=''; $('#leaderboard').innerHTML='';
    }

    // ====== Room listeners ======
    let unsubs=[];
    function listenRoom(){
      unsubs.forEach(u=>u && u()); unsubs=[]
      if(!pin) return;

      // Players
      const un1 = _fb.onValue(roomRefs.players, snap=>{
        const players = snap.val()||{}; renderPlayers(players);
        // Assign lanes deterministically by join order
        const ids = Object.keys(players).sort((a,b)=>players[a].joinedAt-players[b].joinedAt)
        ids.forEach((id,i)=>{ players[id].laneIdx=i })
        if(me && players[myUser.uid]){ myLane = players[myUser.uid].laneIdx || 0 }
        game.setPlayers(players)
        maybeEnableStart(players)
      });

      // State
      const un2 = _fb.onValue(roomRefs.state, snap=>{
        const st=snap.val()||{}; if(!st.status) return;
        if(st.status==='running' && startedAt==null){ startedAt=st.startedAt; durationMs=(durationMs||0); game.start(startedAt, st.endsAt) }
        if(st.status==='ended'){ game.end() }
      })

      // Settings
      const un3 = _fb.onValue(roomRefs.settings, snap=>{ const s=snap.val()||{}; durationMs=s.durationMs||durationMs; minPlayers=s.minPlayers||minPlayers })

      // Questions
      const un4 = _fb.onValue(roomRefs.questions, snap=>{ const q=snap.val()||[]; game.setQuestions(q) })

      unsubs=[un1,un2,un3,un4]
    }

    function maybeEnableStart(players){
      if(!isAdmin){ $('#btnStart').disabled=true; $('#btnStart').classList.remove('good'); return }
      const count=Object.keys(players||{}).length
      const allHaveChar = Object.values(players||{}).every(p=>p.characterId)
      if(count>=minPlayers && allHaveChar){ $('#btnStart').disabled=false; $('#btnStart').classList.add('good') }
      else{ $('#btnStart').disabled=true; $('#btnStart').classList.remove('good') }
    }

    function renderPlayers(players){
      const list=$('#playerList'); list.innerHTML='';
      Object.values(players).sort((a,b)=>a.joinedAt-b.joinedAt).forEach(p=>{
        const div=document.createElement('div'); div.className='player';
        div.innerHTML=`<span>${CHARACTERS.find(c=>c.id==p.characterId)?.emoji||'üë§'} ${p.name}</span><span class="score">${p.score||0}</span>`
        list.appendChild(div)
      })
      const lb=$('#leaderboard'); lb.innerHTML='';
      Object.values(players).sort((a,b)=>(b.score||0)-(a.score||0)).forEach((p,i)=>{
        const div=document.createElement('div'); div.className='player';
        div.innerHTML=`<span>${i+1}. ${p.name}</span><span class="score">${p.score||0}</span>`
        lb.appendChild(div)
      })
    }

    // ====== Parse Questions ======
    function parseQuestionBank(text){
      const lines=text.split(/\n+/).map(s=>s.trim()).filter(Boolean)
      return lines.map((ln,idx)=>{
        const parts=ln.split('|').map(s=>s.trim())
        const [q,a,b,c,d,ans]=parts
        const opt=[a,b,c,d]
        const ansIdx = ({A:0,B:1,C:2,D:3}[String(ans||'').toUpperCase()] ?? 0)
        return { id: 'q'+(idx+1), q, opt, ansIdx }
      })
    }

    // ====== Game Rendering ======
    const canvas=$('#game'); const ctx=canvas.getContext('2d');
    function resize(){ const r=canvas.getBoundingClientRect(); canvas.width=r.width*2; canvas.height=r.height*2; }
    window.addEventListener('resize',resize); resize()

    const game={
      players:{}, questions:[], qSchedule:[],
      started:false, endsAt:null, myQuestionIdx:0, lastTick:0,
      setPlayers(p){ this.players=p },
      setQuestions(q){ this.questions=q; this.buildSchedule() },
      buildSchedule(){
        if(!this.questions.length||!durationMs) return; // schedule per player locally
        const interval = Math.max(3000, Math.floor(durationMs/this.questions.length));
        this.qSchedule = this.questions.map((_,i)=> i*interval )
      },
      start(tsStart, tsEnd){ this.started=true; this.endsAt=tsEnd; this.myQuestionIdx=0; this.lastTick=now(); loop() },
      end(){ this.started=false; showEnd(); }
    }

    // Entities animation helpers
    function drawScene(){
      const w=canvas.width, h=canvas.height; ctx.save(); ctx.scale(2,2); // normalize for HiDPI
      // Sky
      const sky=ctx.createLinearGradient(0,0,0,h/2); sky.addColorStop(0,'#e8f6ff'); sky.addColorStop(1,'#bfe7ff');
      ctx.fillStyle=sky; ctx.fillRect(0,0,w/2,h/2)
      // Birds
      const t=Date.now()/700; for(let i=0;i<5;i++){ const x=((t+i*50)%300); const y=20+10*Math.sin(t+i); drawBird(20+x, 30+(i%2)*10) }
      // River
      ctx.fillStyle=varColor('--river'); ctx.fillRect(0,h/2-40,w/2,80)
      // River shimmer
      ctx.fillStyle=varColor('--river-deep'); for(let i=0;i<8;i++){ ctx.globalAlpha=.12; ctx.fillRect((i*60 + (Date.now()/10)%60), h/2-35, 40, 70) } ctx.globalAlpha=1
      // Fish jump
      drawFish(40 + (Date.now()/6)%260, h/2-10 - 10*Math.sin(Date.now()/200))
      // Crocodiles
      drawCroc(120, h/2+10+10*Math.sin(Date.now()/300)); drawCroc(240, h/2-15+10*Math.cos(Date.now()/250))
      // Grass
      ctx.fillStyle=varColor('--grass'); ctx.fillRect(0,h/2+40,w/2,h/2-40)
      // Jungle path lanes
      for(let i=0;i<Math.max(1,Object.keys(game.players).length);i++){
        const y=h/2+60+i*26; ctx.fillStyle=varColor('--path'); ctx.fillRect(0,y, w/2, 18)
      }
      ctx.restore()
    }

    function varColor(name){ const v=getComputedStyle(document.documentElement).getPropertyValue(name); return v||'#000' }

    function drawBird(x,y){ ctx.save(); ctx.scale(2,2); ctx.fillStyle='#333'; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+6,y+3); ctx.lineTo(x+12,y); ctx.lineTo(x+6,y+2); ctx.closePath(); ctx.fill(); ctx.restore() }
    function drawFish(x,y){ ctx.save(); ctx.scale(2,2); ctx.fillStyle='#f59e0b'; ctx.beginPath(); ctx.ellipse(x,y,8,4,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(x-10,y); ctx.lineTo(x-16,y-4); ctx.lineTo(x-16,y+4); ctx.closePath(); ctx.fill(); ctx.restore() }
    function drawCroc(x,y){ ctx.save(); ctx.scale(2,2); ctx.fillStyle='#14532d'; ctx.fillRect(x-18,y-4,36,8); ctx.fillRect(x+10,y-6,8,12); ctx.restore() }

    // Answer boards for current question (per-player local)
    let currentBoards=[]; // [{text, correct, x,y,w,h}]
    function spawnBoards(q){
      const w=canvas.width, h=canvas.height; const baseY=(h/2)+60+ myLane*52; const left=30; const gap=90; currentBoards=[]
      for(let i=0;i<4;i++){
        const isCorrect = (i===q.ansIdx)
        currentBoards.push({text:q.opt[i], correct:isCorrect, x:left + i*gap, y:baseY-20, w:80, h:26})
      }
    }

    function drawBoards(){
      ctx.save(); ctx.scale(2,2);
      currentBoards.forEach(b=>{
        ctx.fillStyle=b.correct? '#dcfce7': '#fee2e2';
        ctx.strokeStyle=b.correct? '#16a34a':'#ef4444';
        ctx.lineWidth=1; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.strokeRect(b.x,b.y,b.w,b.h);
        ctx.fillStyle=b.correct? '#166534':'#7f1d1d'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(b.text, b.x+b.w/2, b.y+b.h/2)
      })
      ctx.restore()
    }

    // Player avatar
    function drawPlayers(){
      const w=canvas.width, h=canvas.height; ctx.save(); ctx.scale(2,2);
      const ids=Object.keys(game.players)
      ids.forEach((id,i)=>{
        const p=game.players[id]; const laneY=(h/2)/2+60+i*26+9
        const x=20 + progressX(p)
        const isMe = me && id===me.uid
        const emoji=CHARACTERS.find(c=>c.id==p.characterId)?.emoji || 'üë§'
        ctx.font='20px serif'; ctx.fillText(emoji, x, laneY)
        ctx.font='11px system-ui'; ctx.fillStyle=isMe?'#0a3a7a':'#111827';
        ctx.fillText(`${p.name} (${p.score||0})`, x+14, laneY)
        // gun silhouette
        ctx.fillStyle='#333'; ctx.fillRect(x+8, laneY-10, 8, 3)
      })
      ctx.restore()
    }

    function progressX(p){
      if(!startedAt||!game.endsAt) return 0; const t=now(); const frac=Math.min(1, Math.max(0, (t-startedAt)/(game.endsAt-startedAt) ));
      return frac * (canvas.width/2 - 120)
    }

    // Shooting (tap/click)
    canvas.addEventListener('click', (ev)=>{
      if(!game.started||!me||!currentBoards.length) return;
      const r=canvas.getBoundingClientRect(); const x=(ev.clientX - r.left)*2; const y=(ev.clientY - r.top)*2;
      for(const b of currentBoards){ if(x>=b.x*2 && x<= (b.x+b.w)*2 && y>=b.y*2 && y<= (b.y+b.h)*2){
        $('#sndShoot').currentTime=0; $('#sndShoot').play().catch(()=>{})
        if(b.correct){ me.score=(me.score||0)+1; _fb.update(_fb.ref(db,`rooms/${pin}/players/${myUser.uid}`),{score: me.score})
          toast('‚úÖ ‡§∏‡§π‡•Ä!')
        }else{ toast('‚ùå ‡§ó‡§≤‡§§') }
        currentBoards.length=0; break;
      }}
    })

    function loop(){
      if(!game.started) return; requestAnimationFrame(loop)
      ctx.clearRect(0,0,canvas.width, canvas.height)
      drawScene(); drawPlayers(); drawHUD();
      // schedule question boards
      if(game.started && startedAt){
        const elapsed= now()-startedAt; const idx= game.qSchedule.findIndex(t=> elapsed < t );
        let activeIdx = (idx===-1? game.qSchedule.length-1 : Math.max(0, idx-1));
        if(activeIdx !== game.myQuestionIdx){
          game.myQuestionIdx = activeIdx; const q=game.questions[activeIdx]; if(q) spawnBoards(q)
        }
      }
      drawBoards()
    }

    function drawHUD(){
      ctx.save(); ctx.scale(2,2); ctx.fillStyle='#0b1220'; ctx.font='12px system-ui';
      if(startedAt && game.endsAt){ const leftMs=Math.max(0, game.endsAt - now()); const m=Math.floor(leftMs/60000), s=Math.floor((leftMs%60000)/1000); ctx.fillText(`‚è±Ô∏è ${m}:${String(s).padStart(2,'0')}`, 12, 16); if(leftMs<=0){ endGame() } }
      ctx.restore()
    }

    async function endGame(){
      if(!pin) return; await _fb.update(roomRefs.state,{ status:'ended' });
    }

    function showEnd(){
      const overlay=$('#overlay'); overlay.classList.remove('hidden');
      $('#sndClap').currentTime=0; $('#sndClap').play().catch(()=>{})
      $('#overlayText').innerHTML='<div style="font-size:22px;margin-bottom:6px">üëè The End</div><div>‡§∏‡§¨‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§Ö‡§Ç‡§ï ‡§µ‡§æ‡§≤‡•á ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä:</div>'
      const players=Object.values(game.players).sort((a,b)=>(b.score||0)-(a.score||0));
      const list=players.map((p,i)=>`${i+1}. ${p.name} ‚Äî ${p.score||0}`).join('<br>')
      $('#rankList').innerHTML=list
    }

    // ====== Quality of life ======
    // Disable join until a character is selected
    const joinBtn=$('#btnJoinRoom'); const observeSel=()=>{ joinBtn.disabled=!$('.char.selected') }
    setInterval(observeSel,300)

    // ====== END ======
  </script>
</body>
</html>
